# 校园二手交易平台 - 交易模块实现文档

## 📋 项目概述

本项目为校园二手交易平台的交易模块，实现了完整的订单管理和支付处理功能，包括用户身份认证、管理员审核、订单创建、支付宝/微信支付集成等核心功能。

## ✅ 已完成功能

### 1. 数据库模型 (Models)

#### 核心模型
- **User.ts** - 用户模型（已更新）
  - 新增字段：`student_card_url`（学生证照片URL）
  - 更新字段：`auth_status`（0=待审核，1=已通过，2=已拒绝）

- **Admin.ts** - 管理员模型
  - 支持超级管理员和普通管理员角色
  - 邀请码注册机制

- **AdminInviteCode.ts** - 管理员邀请码模型
  - 邀请码生成、使用、过期管理

- **UserAuthAudit.ts** - 用户认证审核模型
  - 审核记录、状态跟踪、拒绝原因

- **Order.ts** - 订单模型（已转换为TypeScript）
  - 订单状态管理
  - 支付状态跟踪
  - 买家卖家关联

- **PaymentRecord.ts** - 支付记录模型
  - 支付方式（支付宝/微信）
  - 支付状态跟踪
  - 第三方交易号记录
  - 退款信息管理

### 2. 服务层 (Services)

#### 管理员服务
- **admin.service.ts**
  - 管理员注册（需邀请码）
  - 管理员登录
  - 邀请码生成（仅超级管理员）
  - 邀请码列表查询

- **adminAuth.service.ts**
  - 获取待审核的认证申请
  - 审核通过/拒绝用户认证
  - 查看用户认证历史

#### 订单服务
- **order.service.ts**
  - 创建订单（验证用户身份认证）
  - 查询订单详情
  - 获取用户订单列表
  - 取消订单
  - 确认收货
  - 卖家发货
  - 更新订单支付状态

#### 支付服务
- **payment.service.ts** - 支付核心服务
  - 创建支付
  - 处理支付宝回调
  - 处理微信支付回调
  - 查询支付状态

- **alipay.service.ts** - 支付宝集成
  - PC网站支付
  - 手机网站支付
  - 查询支付订单
  - 验证回调签名
  - 申请退款
  - 关闭交易

- **wechat.service.ts** - 微信支付集成
  - Native扫码支付
  - H5手机网页支付
  - 查询支付订单
  - 验证回调签名
  - 申请退款
  - 关闭订单

#### 认证服务
- **auth.service.ts**（已更新）
  - 用户注册
  - 用户登录
  - 获取用户信息
  - **新增**：提交身份认证申请

### 3. 控制器 (Controllers)

- **admin.controller.ts** - 管理员操作
- **adminAuth.controller.ts** - 认证审核操作
- **order.controller.ts** - 订单操作
- **payment.controller.ts** - 支付操作
- **auth.controller.ts**（已更新） - 用户认证操作

### 4. 中间件 (Middleware)

- **checkUserAuth.ts** - 验证用户已通过身份认证
  - 检查用户是否已通过实名认证
  - 拦截未认证用户创建订单

- **checkAdminRole.ts** - 管理员权限验证
  - `checkAdminAuth` - 验证管理员身份
  - `checkSuperAdmin` - 验证超级管理员权限

### 5. 工具函数 (Utils)

- **generateOrderNo.ts** - 生成唯一订单号和支付流水号
- **dateHelper.ts** - 日期格式化和计算工具
- **signatureVerification.ts** - 支付回调签名验证
  - RSA签名验证（支付宝）
  - MD5签名验证（微信支付）

### 6. 路由 (Routes)

#### 管理员路由 (`/api/admin`)
```
POST   /register              - 管理员注册（需邀请码）
POST   /login                 - 管理员登录
POST   /invite/generate       - 生成邀请码（仅超级管理员）
GET    /invite/list           - 查看邀请码列表（仅超级管理员）
GET    /auth/list             - 查看认证申请列表
POST   /auth/audit            - 审核用户认证
GET    /auth/history/:userId  - 查看用户认证历史
```

#### 用户认证路由 (`/api/auth`)
```
POST   /register              - 用户注册
POST   /login                 - 用户登录
GET    /user/info             - 获取用户信息
POST   /user/auth             - 提交身份认证申请
```

#### 订单路由 (`/api/order`)
```
POST   /create                - 创建订单（需身份认证）
GET    /:id                   - 获取订单详情
GET    /list                  - 获取用户订单列表
PUT    /:id/cancel            - 取消订单
PUT    /:id/complete          - 确认收货
PUT    /:id/ship              - 卖家发货
```

#### 支付路由 (`/api/payment`)
```
POST   /create                - 创建支付
GET    /status/:orderId       - 查询支付状态
POST   /alipay/callback       - 支付宝异步回调（公开）
POST   /wechat/callback       - 微信支付异步回调（公开）
```

## 📊 数据库表设计

### 新增/更新的表

1. **users** 表（更新）
   - 新增：`student_card_url` VARCHAR(500) - 学生证照片URL
   - 更新：`auth_status` 含义调整为 0=待审核，1=已通过，2=已拒绝

2. **admins** 表（新建）
   - 管理员ID、用户名、邮箱、密码、角色、状态等

3. **admin_invite_codes** 表（新建）
   - 邀请码、创建者、使用者、状态、过期时间等

4. **user_auth_audits** 表（新建）
   - 用户ID、真实姓名、学生证URL、审核状态、管理员ID、拒绝原因等

5. **payment_records** 表（新建）
   - 订单ID、支付方式、金额、支付状态、第三方交易号、回调数据等

## 🔄 业务流程

### 1. 用户认证流程
```
用户提交认证 → 管理员审核 → 通过/拒绝 → 更新用户状态
```

### 2. 订单创建流程
```
验证用户身份认证 → 创建订单 → 生成订单号 → 返回订单信息
```

### 3. 支付流程（支付宝）
```
创建支付 → 调用支付宝API → 用户扫码/跳转支付 →
支付宝异步回调 → 验证签名 → 更新订单和支付状态 → 通知用户
```

### 4. 支付流程（微信支付）
```
创建支付 → 调用微信支付API → 用户扫码/跳转支付 →
微信异步回调 → 验证签名 → 更新订单和支付状态 → 通知用户
```

## 🔒 安全措施

### 1. 身份认证
- JWT Token验证
- 用户实名认证机制
- 管理员邀请码制度

### 2. 支付安全
- 签名验证（RSA/MD5）
- 金额校验
- 订单状态验证
- 数据库事务保证原子性
- 幂等性保护（防止重复支付）

### 3. 权限控制
- 买家只能查看自己的订单
- 卖家只能查看相关订单
- 管理员权限分级

## 🚀 部署指南

### 1. 环境要求
- Node.js >= 18.0.0
- MySQL 8.0
- Redis（可选）

### 2. 安装依赖
```bash
cd SwordFIsh-Backend
npm install
```

### 3. 配置环境变量
复制 `.env.example` 为 `.env`，并填写配置：
```bash
cp .env.example .env
```

重要配置项：
- 数据库连接信息
- JWT密钥
- 支付宝配置（AppID、私钥、公钥）
- 微信支付配置（AppID、商户号、API密钥）
- 回调通知URL（需要公网可访问）

### 4. 数据库初始化
```bash
# 启动MySQL（使用docker-compose）
docker-compose up -d

# 运行数据库迁移
npm run migrate
```

### 5. 启动服务
```bash
# 开发环境
npm run dev

# 生产环境
npm run build
npm start
```

## 📦 依赖包

### 核心依赖
- **express** - Web框架
- **sequelize** - ORM
- **mysql2** - MySQL驱动
- **redis** - Redis客户端
- **jsonwebtoken** - JWT认证
- **bcrypt** - 密码加密

### 支付相关
- **alipay-sdk** - 支付宝SDK
- **axios** - HTTP客户端（微信支付API调用）

### 工具库
- **dotenv** - 环境变量管理
- **helmet** - 安全中间件
- **cors** - 跨域处理
- **joi** - 数据验证

## 🧪 测试

### 支付宝沙箱测试
1. 访问 https://open.alipay.com/develop/sandbox/app
2. 获取沙箱AppID和密钥
3. 使用沙箱账号进行测试

### 微信支付沙箱测试
1. 访问微信支付商户平台
2. 申请沙箱环境
3. 获取测试密钥进行测试

## ⚠️ 注意事项

### 1. 支付回调
- 回调URL必须是公网可访问的地址
- 本地开发可使用 ngrok 等内网穿透工具
- 生产环境必须使用HTTPS

### 2. 密钥安全
- 私钥文件不要提交到代码库
- 使用环境变量管理敏感信息
- 定期更换密钥

### 3. 数据库事务
- 订单和支付操作使用事务
- 确保数据一致性
- 做好异常回滚处理

### 4. 日志记录
- 所有支付操作需记录日志
- 保留足够的审计信息
- 便于问题排查

## 🔧 常见问题

### 1. 支付宝签名验证失败
- 检查公钥私钥是否正确
- 确认是否使用了正确的签名类型（RSA2）
- 检查参数排序和编码

### 2. 微信支付回调收不到
- 确认回调URL可公网访问
- 检查域名是否已备案
- 验证XML解析是否正确

### 3. 订单状态异常
- 检查数据库事务是否正确提交
- 查看日志确认回调是否正常处理
- 验证订单状态机流转逻辑

## 📚 相关文档

- [支付宝开放平台文档](https://opendocs.alipay.com/open/270/105898)
- [微信支付开发文档](https://pay.weixin.qq.com/wiki/doc/api/index.html)
- [Sequelize官方文档](https://sequelize.org/)
- [Express官方文档](https://expressjs.com/)

## 👥 开发团队

- 项目时间：2025年1月
- 技术栈：Node.js + TypeScript + MySQL + Redis
- 支付集成：支付宝 + 微信支付

---

**注意**：本文档为交易模块的完整实现文档，包含所有核心功能的详细说明。在实际部署前，请务必仔细阅读并配置相关参数。
